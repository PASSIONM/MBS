<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="V1_Reservation">
	
	<insert id="insertReservation" parameterType="V1_Reservation">
		
			INSERT INTO `reservation` (rsv_day, rsv_time, rsv_personnel, rsv_sub_id, rsv_sub_name, rsv_sub_tel, rsv_sub_email, rsv_sub_request, str_number, rsv_date)
			VALUES(#{rsv_day}, #{rsv_time}, #{rsv_personnel}, #{rsv_sub_id}, #{rsv_sub_name}, #{rsv_sub_tel}, #{rsv_sub_email}, #{rsv_sub_request}, #{str_number}, NOW());
		<selectKey resultType="int" keyProperty="rsv_no" order="AFTER">	
			SELECT LAST_INSERT_ID();
   		</selectKey>

		<foreach item="tmp" collection="rmlist" separator=" ">
			INSERT INTO `rsv_menu` (rsv_mn_name, rsv_mn_cnt, rsv_mn_price, rsv_mn_date, rsv_no)
			VALUES(#{tmp.rsv_mn_name}, #{tmp.rsv_mn_cnt}, #{tmp.rsv_mn_price}, NOW(), #{rsv_no});
		</foreach>
		 
	</insert>
	
	<select id="selectRsvList" parameterType="V1_Reservation" resultType="V1_Reservation">
		SELECT s.str_name, rc.rsv_day, rc.rsv_code, rc.rsv_code_chk, rc.rsv_no FROM `store` s
		INNER JOIN
			(SELECT r.rsv_day, r.rsv_code, c.rsv_code_chk, r.str_number, r.rsv_no FROM `reservation` r 
				INNER JOIN `rsv_code` c
				ON r.rsv_code = c.rsv_code
			WHERE r.rsv_sub_id=#{rsv_sub_id} AND c.rsv_code=#{rsv_code}) rc
		ON s.str_number = rc.str_number
	</select>
	
	<select id="selectRsvListTot" parameterType="V1_Reservation" resultType="V1_Reservation">
		SELECT s.str_name, rc.rsv_day, rc.rsv_code, rc.rsv_code_chk, rc.rsv_no FROM `store` s
		INNER JOIN
			(SELECT r.rsv_day, r.rsv_code, c.rsv_code_chk, r.str_number, r.rsv_no FROM `reservation` r 
				INNER JOIN `rsv_code` c
				ON r.rsv_code = c.rsv_code
			WHERE r.rsv_sub_id=#{rsv_sub_id}) rc
		ON s.str_number = rc.str_number
	</select>
	
	<select id="selectRsvOne" parameterType="V1_Reservation" resultType="V1_Reservation">
		SELECT s.str_name, s.str_tel, s.str_address, r.rsv_no, r.rsv_day, r.rsv_time, r.rsv_personnel, r.rsv_sub_id, r.rsv_sub_name, r.rsv_sub_tel, r.rsv_sub_email, r.rsv_sub_request, r.str_number, r.rsv_delete, r.rsv_code
		FROM `reservation` r 
			INNER JOIN `store` s
			ON r.str_number = s.str_number
		WHERE r.rsv_no=#{rsv_no}
	</select>
	
	<select id="countRsvTot" resultType="int">
		SELECT COUNT(*) AS cnt FROM `reservation`
	</select>
	<select id="countRsvExp" parameterType="int" resultType="int">
		SELECT COUNT(*) AS cnt FROM `reservation` WHERE rsv_code=1
	</select>
	<select id="countRsvCom" parameterType="int" resultType="int">
		SELECT COUNT(*) AS cnt FROM `reservation` WHERE rsv_code=2
	</select>
	<select id="countRsvCan" parameterType="int" resultType="int">
		SELECT COUNT(*) AS cnt FROM `reservation` WHERE rsv_code=3
	</select>
	
	<update id="updateRsv" parameterType="V1_Reservation">
		UPDATE `reservation` SET rsv_day=#{rsv_day}, rsv_time=#{rsv_time}, rsv_personnel=#{rsv_personnel}, rsv_sub_name=#{rsv_sub_name}, rsv_sub_tel=#{rsv_sub_tel}, rsv_sub_email=#{rsv_sub_email}, rsv_sub_request=#{rsv_sub_request}, rsv_code=1 WHERE rsv_no=#{rsv_no}
	</update>
	
	<update id="cancelRsv" parameterType="int">
		UPDATE `reservation` SET rsv_code=3 WHERE rsv_no=#{rsv_no}
	</update>
		
</mapper>